name: Release

on:
  push:
    tags:
      - 'v*'

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      - run: flutter pub get
      - run: flutter build windows --release
      - name: Code-sign
        shell: pwsh
        env:
          CERT: ${{ secrets.WIN_CERT_B64 }}
          PASS: ${{ secrets.WIN_CERT_PASS }}
        run: |
          $cert = [Convert]::FromBase64String($env:CERT)
          $file = "$env:TEMP\cert.p12"
          [IO.File]::WriteAllBytes($file, $cert)
          & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x86\signtool.exe" sign /f $file /p "$env:PASS" /tr http://timestamp.digicert.com /td sha256 /fd sha256 build/windows/runner/Release/fractal_wallet.exe
      - uses: actions/upload-artifact@v4
        with:
          name: fractal-wallet-win
          path: build/windows/runner/Release/

  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      - run: flutter pub get
      - name: Decode upload keystore
        env:
          KEYSTORE: ${{ secrets.ANDROID_KEYSTORE_B64 }}
        run: echo "$KEYSTORE" | base64 -d > android/app/upload-keystore.jks
      - run: flutter build apk --release
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASS }}
          KEY_ALIAS: upload
          KEY_PASSWORD: ${{ secrets.KEY_PASS }}
      - uses: actions/upload-artifact@v4
        with:
          name: fractal-wallet-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
      - run: flutter pub get
      - run: flutter build web --release --pwa-strategy offline-first
      - uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: build/web
